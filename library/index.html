<!DOCTYPE html>
<html>
<head>
	<title>Tic-tac-toe using state channels</title>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.15/vue.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/0.3.14/peer.min.js"></script>
	<style type="text/css">
		#game-wrapper {
			display: flex;
			flex-wrap: wrap;
			width: 300px;
			margin: 20px;
		}
		#game-wrapper button {
			width: 100px;
			height: 100px;
			border: 0;
			background: transparent;
			font-size: 24px;
			border: 1px solid gray;
		}
	</style>
</head>
<body>
	<div id="app">
		<button @click="() => host()">Play as X (host)</button><br>
		<button @click="() => connect()">Play as O (connect)</button>
		<div id="game-wrapper" v-show="showGame">
			<button 
				v-for="j, i in board"
				@click="() => play(i)"
			>
				{{numToChar(board[i])}}
			</button>
		</div>
		<div>
			{{ this.board }}
		</div>
	</div>
	<script type="text/javascript">
		const numToChar = (i) => {
			switch (i) {
				case 1: return 'x';
				case 2: return 'o';
			}
		}

		var peer;
		var conn;

		new Vue({
		  el: '#app',
		  data: {
		  	showGame: false,
		  	char: 1,
		    board: [0,0,0, 0,0,0, 0,0,0],
		    turnNumber: 0,
		  },
		  computed: {
		    getState: function () {
		      return {
		      	board: this.board
		      };
		    }
		  },
		  methods: {
		  	switchToUse(char) {
		  		this.char = char;
		  	},
		  	play(i) {
		  		this.board.splice(i, 1, this.char);
		  		this.turnNumber++;
		  		// send state;
		  		conn.send({
		  			type: 'state',
		  			...this.getState
		  		});
		  	},
		  	connect() {
		  		const that = this;
		  		this.switchToUse(2);
				peer = new Peer('connect', {
				  key: '1nxd86jzykdwjyvi',
				  debug: 3,
				});
				conn = peer.connect('host');
		  		conn.on('open', function(){
		  			that.showGame = true;
		  		});
	  			conn.on('data', function(data){
	  				console.log('Message', data);
	  				if (data.type === 'state') {
	  					that.board = data.board;
	  				}
	  			});
			},
			host() {
		  		const that = this;
				peer = new Peer('host', {
				  key: '1nxd86jzykdwjyvi',
				  debug: 3,
				});
		  		peer.on('connection', function(_conn) {
		  			that.showGame = true;
		  			conn = _conn
		  			conn.on('data', function(data){
		  				console.log('Message', data);
		  				if (data.type === 'state') {
		  					that.board = data.board;
		  				}
		  			});
		  		});
			}
		  }
		})
	</script>
</body>
</html>